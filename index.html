<script>
  const firebaseConfig = {
    apiKey: "AIzaSyASdljETbk28Lx8iNtKT3sQyP8jGv5_Z2c",
    authDomain: "mini-app-prazos.firebaseapp.com",
    projectId: "mini-app-prazos",
    storageBucket: "mini-app-prazos.appspot.com",
    messagingSenderId: "865106773358",
    appId: "1:865106773358:web:d6958799a298ff3545ed7f"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginSection = document.getElementById("login-section");
  const appSection = document.getElementById("app-section");
  const taskForm = document.getElementById("task-form");
  const tasksList = document.getElementById("tasks-list");
  const logoutBtn = document.getElementById("logout-btn");

  document.getElementById("login-btn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (e) {
      alert("Erro no login: " + e.message);
    }
  };

  document.getElementById("register-btn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await auth.createUserWithEmailAndPassword(email, password);
    } catch (e) {
      alert("Erro no registro: " + e.message);
    }
  };

  logoutBtn.onclick = () => auth.signOut();

  auth.onAuthStateChanged(user => {
    if (user) {
      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      carregarTarefas(user.uid);
    } else {
      loginSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
  });

  taskForm.onsubmit = async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;

    const titulo = document.getElementById("titulo").value;
    const descricao = document.getElementById("descricao").value;
    const cliente = document.getElementById("cliente").value;
    const prazo = document.getElementById("prazo").value;
    const prioridade = document.getElementById("prioridade").value;

    await db.collection("users").doc(user.uid).collection("tasks").add({
      titulo, descricao, cliente, prazo, prioridade,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    taskForm.reset();
  };

  function carregarTarefas(uid) {
    db.collection("users").doc(uid).collection("tasks")
      .orderBy("prazo")
      .onSnapshot(snapshot => {
        tasksList.innerHTML = "";
        snapshot.forEach(doc => {
          const t = doc.data();
          const li = document.createElement("li");

          const hoje = new Date();
          const prazo = new Date(t.prazo);
          const total = prazo - new Date(t.createdAt?.toDate?.() || hoje);
          const decorrido = hoje - new Date(t.createdAt?.toDate?.() || hoje);
          const progresso = total > 0 ? Math.min((decorrido / total) * 100, 100) : 100;

          let classe = "verde";
          if (progresso >= 40 && progresso < 60) classe = "laranja";
          else if (progresso >= 60 && progresso < 85) classe = "vermelho";
          else if (progresso >= 85) classe = "alerta";

          li.className = classe;
          li.textContent = `${t.titulo} - Cliente: ${t.cliente} | Prazo: ${t.prazo} | ${Math.floor(progresso)}% do prazo decorrido`;
          tasksList.appendChild(li);
        });
      });
  }
</script>
